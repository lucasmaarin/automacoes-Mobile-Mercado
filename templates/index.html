<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automações Mobile Mercado</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            --bg: #f8f9fb;
            --surface: #ffffff;
            --surface-alt: #f1f3f9;
            --border: #e2e5ef;
            --border-hover: #c8cdd9;
            --text: #1a1d2e;
            --text-secondary: #5c6078;
            --muted: #8b8fa6;
            --accent: #4f6cf7;
            --accent-hover: #3b55e6;
            --accent-light: #eef1fe;
            --green: #10b981;
            --green-light: #ecfdf5;
            --red: #ef4444;
            --red-light: #fef2f2;
            --orange: #f59e0b;
            --orange-light: #fffbeb;
            --radius: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(15,23,42,.06);
            --shadow: 0 2px 8px rgba(15,23,42,.08);
            --shadow-lg: 0 8px 24px rgba(15,23,42,.1);
            --mono: 'JetBrains Mono','Fira Code','Consolas','Monaco',monospace;
            --transition: .2s cubic-bezier(.4,0,.2,1);
        }

        body.dark {
            --bg: #0f1117;
            --surface: #1a1d2e;
            --surface-alt: #252840;
            --border: #2e3250;
            --border-hover: #3e4270;
            --text: #e8eaf6;
            --text-secondary: #9ba3c4;
            --muted: #6b7194;
            --accent-light: #1e2540;
            --green-light: #0d2620;
            --red-light: #2a1010;
            --orange-light: #2a2010;
            --shadow-sm: 0 1px 3px rgba(0,0,0,.3);
            --shadow: 0 2px 8px rgba(0,0,0,.35);
            --shadow-lg: 0 8px 24px rgba(0,0,0,.4);
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
            -webkit-font-smoothing: antialiased;
        }
        .app { max-width: 980px; margin: 0 auto; }

        /* === Toast === */
        .toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; }
        .toast {
            padding: 12px 18px;
            border-radius: var(--radius);
            font-size: .84rem;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: toastIn .3s cubic-bezier(.22,1,.36,1);
            max-width: 380px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(8px);
        }
        .toast .ico { font-size: 1rem; flex-shrink:0; }
        .toast .close-toast { background:none; border:none; cursor:pointer; opacity:.4; font-size:1.1rem; padding:0 0 0 10px; color:inherit; transition:opacity .15s; }
        .toast .close-toast:hover { opacity:.8; }
        .toast-success { background: rgba(236,253,245,.95); color: #065f46; border-left: 3px solid var(--green); }
        .toast-error { background: rgba(254,242,242,.95); color: #991b1b; border-left: 3px solid var(--red); }
        .toast-warning { background: rgba(255,251,235,.95); color: #92400e; border-left: 3px solid var(--orange); }
        .toast-info { background: rgba(238,241,254,.95); color: #3730a3; border-left: 3px solid var(--accent); }
        @keyframes toastIn { from{transform:translateX(120%);opacity:0} to{transform:translateX(0);opacity:1} }
        @keyframes toastOut { from{opacity:1} to{transform:translateX(120%);opacity:0} }

        /* === Header === */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        .app-header h1 {
            font-size: 1.05rem;
            font-weight: 700;
            letter-spacing: -.02em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .app-header h1::before { content:''; display:inline-block; width:8px; height:8px; border-radius:2px; background:var(--accent); }
        .conn-status {
            font-size: .76rem;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition);
        }
        .conn-status::before { content:''; width:7px; height:7px; border-radius:50%; }
        .conn-ok { background: var(--green-light); color: #065f46; }
        .conn-ok::before { background: var(--green); box-shadow: 0 0 6px rgba(16,185,129,.4); }
        .conn-err { background: var(--red-light); color: #991b1b; }
        .conn-err::before { background: var(--red); }

        /* === Tabs === */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--surface);
            padding: 4px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        .tab-btn {
            flex: 1;
            padding: 10px 20px;
            background: none;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: .84rem;
            font-weight: 600;
            color: var(--muted);
            transition: all var(--transition);
        }
        .tab-btn:hover { color: var(--text); background: var(--surface-alt); }
        .tab-btn.active { background: var(--accent); color: #fff; box-shadow: 0 2px 8px rgba(79,108,247,.3); }
        .tab-panel { display:none; animation: fadeUp .3s ease; }
        .tab-panel.active { display:block; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

        /* === Sub-tabs === */
        .subtabs {
            display: inline-flex;
            background: var(--surface-alt);
            padding: 3px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }
        .stab {
            padding: 7px 16px;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: .8rem;
            font-weight: 600;
            color: var(--muted);
            transition: all var(--transition);
        }
        .stab:hover { color: var(--text); }
        .stab.active { background: var(--surface); color: var(--text); box-shadow: var(--shadow-sm); }
        .spanel { display:none; animation: fadeUp .3s ease; }
        .spanel.active { display:block; }

        /* === Card === */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 18px 20px;
            margin-bottom: 14px;
            box-shadow: var(--shadow-sm);
            transition: box-shadow var(--transition);
        }
        .card-label {
            font-size: .72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: var(--muted);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-label .count {
            background: var(--accent);
            color: #fff;
            font-size: .65rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 700;
            min-width: 22px;
            text-align: center;
        }

        /* === Form === */
        .field { margin-bottom: 12px; }
        .field label {
            display: block;
            font-size: .78rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 7px;
            letter-spacing: 0.3px;
        }
        .field input[type="text"],
        .field input[type="password"],
        .field input[type="number"] {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-size: .84rem;
            color: var(--text);
            background: var(--surface);
            transition: all var(--transition);
            font-family: inherit;
        }
        .field input:hover { border-color: var(--border-hover); background: var(--surface-alt); }
        .field input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(79,108,247,.15); background: var(--surface); }
        .row { display: flex; gap: 12px; align-items: flex-end; }
        .row .field { flex:1; margin-bottom:0; }
        .row .sm { flex: 0 0 90px; }
        .check {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: .82rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 0;
        }
        .check input {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
        }

        /* === Buttons === */
        .btn {
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: .8rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .btn:hover { background: var(--surface-alt); border-color: var(--border-hover); }
        .btn:active { transform: scale(.97); }
        .btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
        .btn-p { background: var(--accent); color: #fff; border-color: var(--accent); }
        .btn-p:hover:not(:disabled) { background: var(--accent-hover); border-color: var(--accent-hover); box-shadow: 0 2px 8px rgba(79,108,247,.25); }
        .btn-d { background: var(--red); color: #fff; border-color: var(--red); }
        .btn-d:hover:not(:disabled) { background: #dc2626; box-shadow: 0 2px 8px rgba(239,68,68,.25); }
        .btn-w { width: 100%; justify-content: center; padding: 11px; font-size: .88rem; border-radius: var(--radius-lg); }
        .btn-ghost { border-color: transparent; background: transparent; color: var(--text-secondary); }
        .btn-ghost:hover { background: var(--surface-alt); color: var(--text); }
        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; }

        /* === Spinner === */
        .spinner { width:15px; height:15px; border:2px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:spin .6s linear infinite; }
        .spinner-dark { border-color:rgba(0,0,0,.1); border-top-color:var(--accent); }
        @keyframes spin { to{transform:rotate(360deg)} }

        /* === Categories === */
        .cat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 6px;
            max-height: 220px;
            overflow-y: auto;
            padding: 2px;
        }
        .cat-grid::-webkit-scrollbar { width: 5px; }
        .cat-grid::-webkit-scrollbar-track { background: transparent; }
        .cat-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .cat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 11px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: .8rem;
            cursor: pointer;
            transition: all .15s;
            user-select: none;
        }
        .cat-item:hover { background: var(--surface-alt); border-color: var(--border-hover); }
        .cat-item.checked { background: var(--accent-light); border-color: rgba(79,108,247,.35); color: var(--accent); font-weight: 600; }
        .cat-item input { margin:0; cursor:pointer; accent-color: var(--accent); }
        .cat-item label { cursor:pointer; flex:1; pointer-events:none; }
        .placeholder { text-align:center; padding:20px; color:var(--muted); font-size:.82rem; }

        /* === Prompt === */
        .prompt-section { margin-bottom: 14px; }
        .prompt-hdr {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: .82rem;
            font-weight: 600;
            color: var(--text-secondary);
            user-select: none;
            transition: all var(--transition);
            box-shadow: var(--shadow-sm);
        }
        .prompt-hdr:hover { background: var(--surface-alt); }
        .prompt-hdr .arr { transition: transform .25s; font-size: .65rem; color: var(--muted); }
        .prompt-hdr.open .arr { transform: rotate(180deg); }
        .prompt-hdr.open { border-radius: var(--radius-lg) var(--radius-lg) 0 0; border-bottom-color: transparent; }
        .prompt-hdr .dot { width:7px; height:7px; border-radius:50%; background:var(--orange); margin-left:8px; display:none; transition: opacity var(--transition); }
        .prompt-hdr .dot.show { display:inline-block; animation: pulse 2s ease infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
        .prompt-bd {
            display: none;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            padding: 16px;
            background: var(--surface);
            box-shadow: var(--shadow-sm);
        }
        .prompt-bd.open { display:block; }
        .prompt-ta {
            width: 100%;
            min-height: 260px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: var(--mono);
            font-size: .78rem;
            line-height: 1.6;
            resize: vertical;
            color: var(--text);
            background: var(--surface-alt);
            transition: border-color var(--transition);
        }
        .prompt-ta:focus { outline:none; border-color:var(--accent); background: var(--surface); box-shadow: 0 0 0 3px rgba(79,108,247,.08); }
        .prompt-ft { display:flex; align-items:center; gap:8px; margin-top:10px; }
        .prompt-ft .hint { margin-left:auto; font-size:.72rem; color:var(--muted); }
        .prompt-ft .hint code { background:var(--surface-alt); padding:2px 6px; border-radius:4px; font-family:var(--mono); font-size:.7rem; }

        /* === Progress === */
        .progress-area { display:none; margin-top:14px; }
        .progress-area.active { display:block; animation: fadeUp .3s ease; }
        .pbar-wrap {
            background: var(--surface-alt);
            border-radius: var(--radius);
            overflow: hidden;
            height: 28px;
            position: relative;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        .pbar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #818cf8);
            width: 0%;
            transition: width .5s cubic-bezier(.4,0,.2,1);
            position: relative;
        }
        .pbar-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.15) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer { from{transform:translateX(-100%)} to{transform:translateX(100%)} }
        .pbar-text { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:.75rem; font-weight:700; color:var(--text); }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        /* === Categorizador progress bar === */
        .prog-wrap {
            background: var(--surface-alt);
            border-radius: var(--radius);
            overflow: hidden;
            height: 24px;
            position: relative;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        .prog-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #818cf8);
            width: 0%;
            transition: width .4s cubic-bezier(.4,0,.2,1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 8px;
        }
        .stat {
            text-align: center;
            padding: 12px 4px 10px;
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        .stat-v { font-size: 1.5rem; font-weight: 800; color: var(--accent); line-height:1; }
        .stat-v.green { color: var(--green); }
        .stat-v.red { color: var(--red); }
        .stat-l { font-size: .68rem; color: var(--muted); margin-top: 4px; font-weight: 500; }
        .tokens-bar {
            display: flex;
            gap: 20px;
            padding: 10px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 12px;
            font-size: .82rem;
            box-shadow: var(--shadow-sm);
        }
        .tokens-bar strong { color: var(--text); font-weight: 700; }
        .tokens-bar span { color: var(--text-secondary); font-weight: 500; }
        .cur-item {
            padding: 12px 14px;
            background: var(--orange-light);
            border: 1px solid #fde68a;
            border-radius: var(--radius);
            margin-bottom: 12px;
            font-size: .82rem;
            line-height: 1.7;
            display: none;
        }
        .cur-item.show { display:block; }
        .cur-item strong { font-weight: 700; }

        /* === Log === */
        .log-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-height: 180px;
            overflow-y: auto;
            padding: 8px;
            box-shadow: var(--shadow-sm);
        }
        .log-box::-webkit-scrollbar { width: 5px; }
        .log-box::-webkit-scrollbar-track { background: transparent; }
        .log-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .log-l {
            padding: 4px 10px;
            border-radius: 5px;
            font-size: .74rem;
            font-family: var(--mono);
            margin-bottom: 3px;
            line-height: 1.5;
        }
        .log-l.info { background: var(--accent-light); color: #3730a3; }
        .log-l.success { background: var(--green-light); color: #065f46; }
        .log-l.error { background: var(--red-light); color: #991b1b; }
        .log-l.warning { background: var(--orange-light); color: #92400e; }

        /* === Explorer === */
        .json-out {
            background: #1a1f36;
            color: #c4caf8;
            border-radius: var(--radius-lg);
            padding: 16px;
            max-height: 400px;
            overflow: auto;
            font-family: var(--mono);
            font-size: .76rem;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,.2);
            border: 1px solid #2d3555;
        }
        .json-out::-webkit-scrollbar { width: 6px; height: 6px; }
        .json-out::-webkit-scrollbar-track { background: transparent; }
        .json-out::-webkit-scrollbar-thumb { background: #3d4566; border-radius: 4px; }
        /* JSON syntax highlighting */
        .json-key  { color: #7dd3fc; }
        .json-str  { color: #86efac; }
        .json-num  { color: #fca5a5; }
        .json-bool { color: #fdba74; }
        .json-null { color: #94a3b8; font-style: italic; }
        .json-punc { color: #6b7194; }
        /* Path chips */
        .path-chip {
            display: inline-flex; align-items: center; gap: 5px;
            font-size: .76rem; font-weight: 600; font-family: inherit;
            padding: 5px 11px; border-radius: 20px; cursor: pointer;
            background: var(--surface-alt); border: 1px solid var(--border);
            color: var(--text-secondary); transition: all var(--transition);
            white-space: nowrap;
        }
        .path-chip:hover { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }
        .sugg-drop {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-height: 140px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
            position: absolute;
            left: 0; right: 0;
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }
        .sugg-opt {
            padding: 8px 12px;
            cursor: pointer;
            font-size: .8rem;
            border-bottom: 1px solid var(--surface-alt);
            transition: background .1s;
        }
        .sugg-opt:hover { background: var(--accent-light); color: var(--accent); }
        .sugg-opt:last-child { border-bottom:none; }
        .field-rel { position:relative; }

        /* === Separator line === */
        .sep { height: 1px; background: var(--border); margin: 14px 0; }

        /* === Establishment select === */
        .est-sel {
            width: 100%; padding: 8px 14px;
            border: 1px solid var(--border); border-radius: var(--radius);
            font-size: .9rem; font-family: inherit; color: var(--text);
            background: var(--bg); outline: none; cursor: pointer;
            transition: border-color var(--transition), box-shadow var(--transition);
        }
        .est-sel:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        .est-custom { margin-top: 6px; }

        /* === Daily counter === */
        .daily-counter {
            font-size: .75rem; padding: 5px 12px; border-radius: 20px;
            background: var(--accent-light); color: var(--accent); font-weight: 600;
            display: flex; align-items: center; gap: 6px; white-space: nowrap;
        }
        .daily-counter strong { font-weight: 700; }

        /* === Category filter chips === */
        .filter-chip {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: .76rem; cursor: pointer;
            background: var(--surface-alt); padding: 4px 10px;
            border-radius: 20px; border: 1px solid var(--border);
            transition: all var(--transition);
        }
        .filter-chip input { accent-color: var(--accent); }
        .filter-chip:has(input:checked) {
            background: var(--accent-light); border-color: var(--accent); color: var(--accent);
        }

        /* === Agent help button + collapsible info === */
        .agent-help-btn {
            display: inline-flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--accent-light); color: var(--accent);
            font-size: .9rem; font-weight: 700; cursor: pointer;
            border: 1.5px solid #c7d2fe; line-height: 1; user-select: none;
            transition: background var(--transition), color var(--transition), box-shadow var(--transition);
            flex-shrink: 0; box-shadow: 0 1px 4px rgba(79,108,247,.15);
        }
        .agent-help-btn:hover { background: var(--accent); color: #fff; box-shadow: 0 2px 10px rgba(79,108,247,.35); }
        .agent-info {
            display: none;
            gap: 10px;
            background: var(--accent-light);
            border: 1px solid #c7d2fe;
            border-radius: var(--radius);
            padding: 12px 14px;
            font-size: .82rem;
            color: #3730a3;
            line-height: 1.55;
            margin-bottom: 2px;
        }
        .agent-info.open { display: flex; }
        .agent-info svg { flex-shrink: 0; margin-top: 1px; }
        .agent-info strong { font-weight: 700; display: block; margin-bottom: 2px; }

        /* === Quota banner === */
        .quota-banner {
            display: none;
            align-items: center;
            gap: 12px;
            background: #fff5f5;
            border-bottom: 2px solid #fca5a5;
            padding: 10px 24px;
            font-size: .85rem;
            color: #b91c1c;
            font-weight: 500;
        }
        .quota-banner.visible { display: flex; }
        .quota-banner svg { flex-shrink: 0; }
        .quota-banner a { color: #b91c1c; font-weight: 700; }
        .quota-banner-close {
            margin-left: auto; background: none; border: none;
            cursor: pointer; color: #b91c1c; font-size: 1.1rem; line-height: 1;
            opacity: .7;
        }
        .quota-banner-close:hover { opacity: 1; }

        /* === Tour === */
        #tourOverlay {
            position: fixed; inset: 0; z-index: 9000;
            pointer-events: none; display: none;
        }
        #tourOverlay.active { pointer-events: all; display: block; }
        #tourSpotlight {
            position: fixed; border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,.58);
            z-index: 9001; pointer-events: none;
            transition: top .28s ease, left .28s ease, width .28s ease, height .28s ease;
        }
        #tourCard {
            position: fixed; background: #fff;
            border-radius: 14px;
            box-shadow: 0 12px 48px rgba(15,23,42,.22), 0 2px 8px rgba(15,23,42,.08);
            padding: 24px 26px 20px; width: 330px; z-index: 9002;
            transition: top .28s ease, left .28s ease;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .tour-label {
            font-size: .68rem; font-weight: 700; color: var(--accent);
            text-transform: uppercase; letter-spacing: .07em; margin-bottom: 10px;
        }
        .tour-dots {
            display: flex; gap: 5px; margin-bottom: 14px;
        }
        .tour-dot {
            width: 7px; height: 7px; border-radius: 50%;
            background: var(--border); transition: background .2s, transform .2s;
        }
        .tour-dot.active { background: var(--accent); transform: scale(1.25); }
        #tourTitle {
            font-size: 1.02rem; font-weight: 700; color: var(--text);
            margin-bottom: 8px; letter-spacing: -.01em;
        }
        #tourText {
            font-size: .84rem; color: var(--text-secondary);
            line-height: 1.65; margin-bottom: 20px;
        }
        .tour-actions {
            display: flex; justify-content: space-between; align-items: center;
        }
        .tour-skip {
            font-size: .75rem; color: var(--muted); cursor: pointer;
            background: none; border: none; font-family: inherit; padding: 0;
        }
        .tour-skip:hover { color: var(--text-secondary); text-decoration: underline; }
        .tour-nav { display: flex; gap: 8px; }
        .tour-btn-prev {
            font-size: .82rem; color: var(--text-secondary); background: var(--surface-alt);
            border: 1px solid var(--border); border-radius: var(--radius); padding: 8px 14px;
            cursor: pointer; font-family: inherit; font-weight: 500;
        }
        .tour-btn-prev:hover { background: var(--border); }
        .tour-btn-next {
            font-size: .82rem; color: #fff; background: var(--accent);
            border: none; border-radius: var(--radius); padding: 8px 18px;
            cursor: pointer; font-family: inherit; font-weight: 600;
            box-shadow: 0 2px 8px rgba(79,108,247,.3);
        }
        .tour-btn-next:hover { background: var(--accent-hover); }

        /* === Skeleton de carregamento === */
        #appSkeleton {
            position: fixed; inset: 0; z-index: 8999;
            background: var(--bg); padding: 24px;
            overflow: hidden; pointer-events: all;
            transition: opacity .35s ease;
        }
        #appSkeleton.sk-hide { opacity: 0; pointer-events: none; }
        @keyframes skShimmer {
            0%   { background-position: -600px 0; }
            100% { background-position:  600px 0; }
        }
        .sk {
            background: linear-gradient(90deg,
                var(--surface-alt) 25%, var(--border) 50%, var(--surface-alt) 75%);
            background-size: 1200px 100%;
            animation: skShimmer 1.5s ease infinite;
            border-radius: var(--radius);
        }
        .sk-hdr  { height: 62px; border-radius: var(--radius-lg); margin-bottom: 24px; }
        .sk-tabs { display: flex; gap: 4px; margin-bottom: 20px; }
        .sk-tabs .sk { flex: 1; height: 52px; border-radius: var(--radius); }
        .sk-tabs .sk:nth-child(2) { animation-delay: .1s; }
        .sk-tabs .sk:nth-child(3) { animation-delay: .2s; }
        .sk-tabs .sk:nth-child(4) { animation-delay: .3s; }
        .sk-card { border-radius: var(--radius-lg); margin-bottom: 14px; }

        @media (max-width: 480px) {
            #appSkeleton { padding: 8px; }
            .sk-tabs .sk { height: 44px; }
        }

        /* ============================================================
           UX/UI EXTRAS
           ============================================================ */

        /* Ponto de conexão com pulso animado */
        @keyframes connPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: .45; transform: scale(1.5); }
        }
        .conn-ok::before { animation: connPulse 2.4s ease infinite; }

        /* Tab icons */
        .tab-btn { display: flex; align-items: center; justify-content: center; gap: 6px; }

        /* Card-label icon */
        .card-label { gap: 8px; }
        .card-label > svg { flex-shrink: 0; opacity: .5; }

        /* Toggle switch */
        .toggle-sw {
            display: inline-flex; align-items: center; gap: 10px;
            cursor: pointer; user-select: none;
            font-size: .84rem; color: var(--text-secondary);
            padding: 5px 0; border: none; background: none;
        }
        .toggle-sw input { position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none; }
        .toggle-track {
            position: relative; width: 36px; height: 20px; flex-shrink: 0;
            background: var(--border); border-radius: 10px; transition: background .2s;
        }
        .toggle-thumb {
            position: absolute; top: 3px; left: 3px;
            width: 14px; height: 14px; border-radius: 50%;
            background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,.25);
            transition: left .2s;
        }
        .toggle-sw input:checked + .toggle-track { background: var(--accent); }
        .toggle-sw input:checked + .toggle-track .toggle-thumb { left: 19px; }

        /* Empty state rico */
        .empty-state {
            display: flex; flex-direction: column; align-items: center;
            padding: 32px 16px; gap: 8px; color: var(--muted);
        }
        .empty-state svg { opacity: .28; }
        .empty-state b { font-size: .82rem; font-weight: 600; color: var(--text-secondary); }
        .empty-state span { font-size: .76rem; text-align: center; line-height: 1.5; }

        /* Log wrapper com header */
        .log-wrap { margin-top: 12px; }
        .log-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .log-title { font-size: .69rem; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); }
        .log-clear { font-size: .7rem; background: none; border: none; cursor: pointer; color: var(--muted); padding: 0; font-family: inherit; transition: color var(--transition); }
        .log-clear:hover { color: var(--text-secondary); text-decoration: underline; }

        /* Report link no header */
        .header-link {
            font-size: .76rem; font-weight: 600; color: var(--accent);
            text-decoration: none; padding: 5px 11px; border-radius: 20px;
            background: var(--accent-light); border: 1px solid rgba(79,108,247,.2);
            transition: all var(--transition); display: inline-flex; align-items: center; gap: 5px;
            white-space: nowrap;
        }
        .header-link:hover { background: var(--accent); color: #fff; }

        /* Undo button melhorado */
        .undo-bar {
            display: none; margin-top: 10px;
            padding: 10px 14px; border-radius: var(--radius);
            background: var(--orange-light); border: 1px solid #fde68a;
            display: flex; align-items: center; gap: 10px;
        }
        .undo-bar .undo-text { font-size: .8rem; color: #92400e; flex: 1; }
        .undo-bar .btn-undo { font-size: .78rem; padding: 5px 12px; border-radius: var(--radius); background: var(--orange); color: #fff; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: background .15s; }
        .undo-bar .btn-undo:hover { background: #d97706; }

        /* ============================================================
           RESPONSIVIDADE MOBILE
           ============================================================ */

        /* Tablet / telas médias */
        @media (max-width: 768px) {
            body { padding: 12px; }

            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 14px 16px;
            }
            .app-header > div:last-child {
                width: 100%;
                justify-content: space-between;
            }

            .tabs {
                flex-wrap: wrap;
                gap: 4px;
            }
            .tab-btn {
                flex: 1 1 calc(50% - 4px);
                padding: 9px 8px;
                font-size: .78rem;
                text-align: center;
            }

            .stats-row {
                grid-template-columns: repeat(3, 1fr);
            }

            .row {
                flex-wrap: wrap;
            }
            .row .sm {
                flex: 1 1 100%;
            }

            .tokens-bar {
                flex-wrap: wrap;
                gap: 10px;
            }

            .daily-counter {
                font-size: .7rem;
                padding: 4px 9px;
            }
        }

        /* Celular pequeno */
        @media (max-width: 480px) {
            body { padding: 8px; }

            .app-header h1 { font-size: .95rem; }

            .tab-btn {
                flex: 1 1 calc(50% - 4px);
                padding: 8px 4px;
                font-size: .74rem;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
            /* Tokens e Custo ficam na última linha inteiros */
            .stats-row .stat:nth-last-child(-n+2):nth-child(odd) {
                grid-column: span 2;
            }

            .card { padding: 14px 14px; }

            .btn-group {
                gap: 4px;
            }
            .btn-group .btn {
                padding: 7px 10px;
                font-size: .75rem;
            }

            .prompt-ta { min-height: 180px; font-size: .73rem; }

            .cat-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }

            .log-box { max-height: 140px; }

            .daily-counter { display: none; }

            .conn-status { font-size: .7rem; padding: 4px 9px; }

            /* Ajuste no cabeçalho com status e sem daily counter no cel */
            .app-header > div:last-child {
                justify-content: flex-end;
            }

            /* Tour card não ultrapassa a largura da tela */
            #tourCard { width: calc(100vw - 32px); min-width: 0; padding: 18px 16px 16px; }

            /* Settings: grid ocupa 100% */
            #tab-settings [style*="max-width:400px"],
            #tab-settings [style*="max-width: 400px"] {
                max-width: 100% !important;
            }

            /* Botões de settings ocupam largura total */
            #tab-settings .btn-p[style*="width:fit-content"],
            #tab-settings .btn-p[style*="width: fit-content"] {
                width: 100% !important;
                justify-content: center;
            }

            /* Linha de .row no explorer avançado empilha */
            #tab-explorer .row {
                flex-direction: column;
            }
            #tab-explorer .row .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Skeleton de carregamento — ocorre enquanto settings e estabelecimentos carregam do Firestore -->
    <div id="appSkeleton">
        <div style="max-width:980px;margin:0 auto">
            <div class="sk sk-hdr"></div>
            <div class="sk-tabs">
                <div class="sk"></div>
                <div class="sk"></div>
                <div class="sk"></div>
                <div class="sk"></div>
            </div>
            <div class="sk sk-card" style="height:128px"></div>
            <div class="sk sk-card" style="height:164px"></div>
            <div class="sk sk-card" style="height:46px"></div>
        </div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <!-- Tour overlay -->
    <div id="tourOverlay">
        <div id="tourSpotlight" style="display:none"></div>
        <div id="tourCard" style="display:none">
            <div class="tour-label" id="tourStepLabel">Passo 1 de 7</div>
            <div class="tour-dots" id="tourDots"></div>
            <div id="tourTitle"></div>
            <p id="tourText"></p>
            <div class="tour-actions">
                <button class="tour-skip" onclick="Tour.skip()">Pular tour</button>
                <div class="tour-nav">
                    <button class="tour-btn-prev" id="tourPrev" onclick="Tour.prev()">Anterior</button>
                    <button class="tour-btn-next" id="tourNext" onclick="Tour.next()">Próximo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="quota-banner" id="quotaBanner">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="quotaBannerMsg">Os créditos da API OpenAI acabaram. Verifique o saldo em <a href="https://platform.openai.com/account/billing" target="_blank">platform.openai.com</a>.</span>
        <button class="quota-banner-close" onclick="document.getElementById('quotaBanner').classList.remove('visible')" title="Fechar">&times;</button>
    </div>

    <div class="app">
        <div class="app-header">
            <h1>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent)"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                Automações Mobile Mercado
            </h1>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <a href="/relatorio" class="header-link" target="_blank">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    Relatório
                </a>
                <div class="daily-counter" title="Uso total de tokens hoje (todos os agentes)">
                    <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    Hoje: <strong id="dailyTokens">0</strong> tokens &bull; <strong id="dailyCost">$0.0000</strong>
                </div>
                <span class="conn-status conn-err" id="connBadge">Desconectado</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('renamer')">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Padronizador de Nomes
            </button>
            <button class="tab-btn" onclick="switchTab('explorer')">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                Explorador Firestore
            </button>
            <button class="tab-btn" onclick="switchTab('categorizer')">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                Categorizador de Produtos
            </button>
            <button class="tab-btn" onclick="switchTab('settings')">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Configurações
            </button>
        </div>

        <!-- TAB: Renamer -->
        <div class="tab-panel active" id="tab-renamer">
            <div style="display:flex;justify-content:flex-end;margin-bottom:6px">
                <span class="agent-help-btn" onclick="toggleHelp('renamerHelp')" title="Como funciona?">?</span>
            </div>
            <div class="agent-info" id="renamerHelp">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                <div>
                    <strong>Padronizador de Nomes</strong>
                    Usa IA para reescrever e padronizar os nomes dos produtos do estabelecimento selecionado.<br>
                    <strong>Fluxo:</strong> selecione o estabelecimento → clique em <em>Carregar</em> para buscar as categorias → marque as categorias desejadas → clique em <em>Iniciar</em>.<br>
                    Ative <em>Modo de teste (Dry Run)</em> para visualizar as alterações sem salvar nada no Firestore. Ao finalizar, um botão de desfazer permite reverter toda a execução.
                </div>
            </div>
            <div class="card">
                <div class="card-label">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>
                    Configurações
                </div>
                <div class="field">
                    <label>Estabelecimento</label>
                    <select id="renEstSel" class="est-sel" onchange="handleEstChange('renEstSel','renEstCustom')">
                        <option value="" disabled>Carregando...</option>
                    </select>
                    <input type="text" id="renEstCustom" class="est-custom" style="display:none" placeholder="ID personalizado" spellcheck="false">
                </div>
                <div class="field" style="margin-top:8px">
                    <label>Delay entre produtos (s)</label>
                    <input type="number" id="delay" value="0" min="0" step="0.1">
                </div>
                <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
                    <label class="toggle-sw">
                        <input type="checkbox" id="dryRun">
                        <span class="toggle-track"><span class="toggle-thumb"></span></span>
                        <span>Modo de teste (Dry Run)</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <div class="card-label" style="margin-bottom:0">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        Categorias <span class="count" id="catCount" style="display:none">0</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-p" id="btnLoadCats" onclick="Renamer.loadCategories()" style="display:flex;align-items:center;gap:5px">
                            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.8"/></svg>
                            Carregar
                        </button>
                        <button class="btn btn-ghost" onclick="Renamer.selectAll(true)">Todas</button>
                        <button class="btn btn-ghost" onclick="Renamer.selectAll(false)">Limpar</button>
                    </div>
                </div>
                <div id="catGrid">
                    <div class="empty-state">
                        <svg width="38" height="38" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        <b>Nenhuma categoria carregada</b>
                        <span>Selecione o estabelecimento e clique<br>em "Carregar" para buscar as categorias</span>
                    </div>
                </div>
            </div>

            <div class="prompt-section">
                <div class="prompt-hdr" id="promptHdr" onclick="Renamer.togglePrompt()">
                    <span style="display:flex;align-items:center;gap:7px">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:.55"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        Instruções da IA <span class="dot" id="promptDot" title="Prompt modificado"></span>
                    </span>
                    <span class="arr">&#9660;</span>
                </div>
                <div class="prompt-bd" id="promptBd">
                    <textarea class="prompt-ta" id="promptTa" placeholder="Carregando..." oninput="Renamer.onPromptChange()" spellcheck="false"></textarea>
                    <div class="prompt-ft">
                        <button class="btn btn-p" onclick="Renamer.savePrompt()">Salvar no Firestore</button>
                        <button class="btn btn-ghost" onclick="Renamer.restorePrompt()">Restaurar Padrao</button>
                    </div>
                </div>
            </div>

            <button class="btn btn-p btn-w" id="btnStart" onclick="Renamer.toggle()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
                Iniciar
            </button>

            <div class="progress-area" id="progressArea">
                <div class="cur-item" id="curItem"><div id="curInfo"></div></div>
                <div class="pbar-wrap"><div class="pbar-fill" id="pbar"></div><div class="pbar-text" id="ptext">0%</div></div>
                <div class="tokens-bar">
                    <span>Tokens: <strong id="tokensVal">0</strong></span>
                    <span>Custo: <strong id="costVal">$0.00</strong></span>
                </div>
                <div class="stats-row">
                    <div class="stat"><div class="stat-v" id="sTotal">0</div><div class="stat-l">Total</div></div>
                    <div class="stat"><div class="stat-v" id="sProc">0</div><div class="stat-l">Processados</div></div>
                    <div class="stat"><div class="stat-v green" id="sUpd">0</div><div class="stat-l">Atualizados</div></div>
                    <div class="stat"><div class="stat-v" id="sUnch">0</div><div class="stat-l">Inalterados</div></div>
                    <div class="stat"><div class="stat-v red" id="sErr">0</div><div class="stat-l">Erros</div></div>
                </div>
                <div class="log-wrap">
                    <div class="log-header">
                        <span class="log-title">Log de execução</span>
                        <button class="log-clear" onclick="$('renamerLog').innerHTML=''">Limpar</button>
                    </div>
                    <div class="log-box" id="renamerLog"><div class="log-l info">Aguardando...</div></div>
                </div>
                <div id="renUndo" style="display:none;margin-top:10px;text-align:center">
                    <button class="btn btn-ghost" style="color:var(--orange);border-color:var(--orange)" onclick="Renamer.undo()">
                        &#8635; Desfazer ultima execucao (<span id="renUndoCount">0</span> produtos)
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB: Categorizador -->
        <div class="tab-panel" id="tab-categorizer">
            <div class="subtabs" id="catSubTabs">
                <button class="stab active" onclick="switchCatSub('auto')">Automático</button>
                <button class="stab" onclick="switchCatSub('dirigido')">Dirigido</button>
            </div>

            <!-- SUB: Automatico -->
            <div class="spanel active" id="catsubtab-auto">
                <div style="display:flex;justify-content:flex-end;margin-bottom:6px">
                    <span class="agent-help-btn" onclick="toggleHelp('catAutoHelp')" title="Como funciona?">?</span>
                </div>
                <div class="agent-info" id="catAutoHelp">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <div>
                        <strong>Categorizador Automático</strong>
                        Analisa o nome de cada produto e define automaticamente a <em>categoria</em> e a <em>subcategoria</em> mais adequada, escolhendo entre todas as opções disponíveis no Firestore.<br>
                        <strong>Filtro de categoria:</strong> clique em <em>Carregar Categorias</em> para filtrar apenas produtos de uma categoria específica.<br>
                        <strong>Apenas sem categoria:</strong> ao ativar esse toggle, o filtro e o carregamento de categorias são desabilitados e apenas produtos sem categoria são processados.<br>
                        Ative <em>Modo de teste (Dry Run)</em> para simular sem salvar. Ao finalizar, um botão de desfazer permite reverter a execução.
                    </div>
                </div>
                <div class="card">
                    <div class="card-label">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>
                        Configuração
                    </div>
                    <div class="row">
                        <div class="field">
                            <label>Estabelecimento</label>
                            <select id="catEstSel" class="est-sel" onchange="handleEstChange('catEstSel','catEstCustom')">
                                <option value="" disabled>Carregando...</option>
                            </select>
                            <input type="text" id="catEstCustom" class="est-custom" style="display:none" placeholder="ID personalizado" spellcheck="false">
                        </div>
                        <div class="field sm"><label>Delay (s)</label><input type="number" id="catDelay" value="0.5" min="0" max="10" step="0.1"></div>
                    </div>
                    <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
                        <label class="toggle-sw">
                            <input type="checkbox" id="catDryRun">
                            <span class="toggle-track"><span class="toggle-thumb"></span></span>
                            <span>Modo de teste (Dry Run)</span>
                        </label>
                        <label class="toggle-sw">
                            <input type="checkbox" id="catOnlyUncategorized" onchange="Cat.onOnlyUncategorizedChange(this.checked)">
                            <span class="toggle-track"><span class="toggle-thumb"></span></span>
                            <span>Apenas produtos sem categoria</span>
                        </label>
                    </div>
                    <div style="margin-top:10px" id="catCategoryFilter">
                        <label style="font-size:.84rem;color:var(--text-secondary);display:block;margin-bottom:6px">Filtrar por categoria (opcional)</label>
                        <button class="btn btn-p" id="catLoadCatsBtn" style="width:100%;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:6px" onclick="Cat.loadCategories()">
                            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.8"/></svg>
                            Carregar Categorias
                        </button>
                        <select id="catFilterCategory" style="width:100%;padding:6px 8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.84rem">
                            <option value="">-- Todas as categorias --</option>
                        </select>
                    </div>
                </div>
                <div class="prompt-section">
                    <div class="prompt-hdr" id="catPromptHdr" onclick="Cat.togglePrompt()">
                        <span style="display:flex;align-items:center;gap:7px">
                            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:.55"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            Instruções da IA <span class="dot" id="catPromptDot" title="Prompt modificado"></span>
                        </span>
                        <span class="arr">&#9660;</span>
                    </div>
                    <div class="prompt-bd" id="catPromptBd">
                        <textarea class="prompt-ta" id="catPromptTa" placeholder="Carregando..." oninput="Cat.onPromptChange()" spellcheck="false"></textarea>
                        <div class="prompt-ft">
                            <button class="btn btn-p" onclick="Cat.savePrompt()">Salvar no Firestore</button>
                            <button class="btn btn-ghost" onclick="Cat.restorePrompt()">Restaurar Padrao</button>
                        </div>
                    </div>
                </div>

                <div class="card" style="text-align:center">
                    <button class="btn btn-p" id="catBtn" onclick="Cat.toggle()" style="min-width:180px">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
                        Iniciar Categorização
                    </button>
                </div>
                <div class="card" id="catProgressCard" style="display:none">
                    <div class="card-label">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        Progresso
                    </div>
                    <div class="prog-wrap"><div class="prog-bar" id="catProg" style="width:0%"></div></div>
                    <div style="font-size:.8rem;color:var(--muted);margin-top:6px;text-align:center" id="catProgLabel">0 / 0</div>
                    <div style="font-size:.78rem;color:var(--text-secondary);margin-top:6px;text-align:center" id="catCurrent"></div>
                    <div class="stats-grid" style="margin-top:12px">
                        <div class="stat"><div class="stat-v" id="catTotal">0</div><div class="stat-l">Total</div></div>
                        <div class="stat"><div class="stat-v" id="catProc">0</div><div class="stat-l">Processados</div></div>
                        <div class="stat"><div class="stat-v green" id="catUpd">0</div><div class="stat-l">Atualizados</div></div>
                        <div class="stat"><div class="stat-v red" id="catErr">0</div><div class="stat-l">Erros</div></div>
                    </div>
                    <div style="font-size:.78rem;color:var(--muted);margin-top:8px;text-align:right" id="catCost"></div>
                </div>
                <div class="log-wrap">
                    <div class="log-header">
                        <span class="log-title">Log de execução</span>
                        <button class="log-clear" onclick="$('catLog').innerHTML=''">Limpar</button>
                    </div>
                    <div class="log-box" id="catLog"><div class="log-l info">Aguardando...</div></div>
                </div>
                <div id="catUndo" style="display:none;margin-top:10px;text-align:center">
                    <button class="btn btn-ghost" style="color:var(--orange);border-color:var(--orange)" onclick="Cat.undo()">
                        &#8635; Desfazer ultima execucao (<span id="catUndoCount">0</span> produtos)
                    </button>
                </div>
            </div>

            <!-- SUB: Dirigido -->
            <div class="spanel" id="catsubtab-dirigido">
                <div style="display:flex;justify-content:flex-end;margin-bottom:6px">
                    <span class="agent-help-btn" onclick="toggleHelp('catDirHelp')" title="Como funciona?">?</span>
                </div>
                <div class="agent-info" id="catDirHelp">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <div>
                        <strong>Categorizador Dirigido</strong>
                        Você escolhe a categoria alvo e a IA define a <em>subcategoria</em> correta para cada produto dessa categoria.<br>
                        <strong>Fluxo:</strong> selecione o estabelecimento → <em>Carregar Categorias</em> → escolha a categoria alvo → clique em <em>Iniciar Modo Dirigido</em>.<br>
                        <strong>Avaliar outros produtos:</strong> ative esse toggle para que a IA também analise produtos de outras categorias e os mova para a categoria alvo quando fizer sentido.<br>
                        Ative <em>Modo de teste (Dry Run)</em> para simular sem salvar. Ao finalizar, um botão de desfazer permite reverter a execução.
                    </div>
                </div>
                <div class="card">
                    <div class="card-label">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>
                        Configuração
                    </div>
                    <div class="row">
                        <div class="field">
                            <label>Estabelecimento</label>
                            <select id="catDirEstSel" class="est-sel" onchange="handleEstChange('catDirEstSel','catDirEstCustom')">
                                <option value="" disabled>Carregando...</option>
                            </select>
                            <input type="text" id="catDirEstCustom" class="est-custom" style="display:none" placeholder="ID personalizado" spellcheck="false">
                        </div>
                        <div class="field sm"><label>Delay (s)</label><input type="number" id="catDirDelay" value="0.5" min="0" max="10" step="0.1"></div>
                    </div>

                    <div class="field" style="margin-top:10px">
                        <label style="margin-bottom:6px">Categoria Alvo</label>
                        <button class="btn btn-p" style="width:100%;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:6px" onclick="CatDir.loadCategories()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.8"/></svg>
                            Carregar Categorias
                        </button>
                        <select id="catDirTarget" class="est-sel">
                            <option value="">-- Carregue as categorias primeiro --</option>
                        </select>
                    </div>

                    <div style="margin-top:12px;display:flex;flex-direction:column;gap:6px">
                        <label class="toggle-sw">
                            <input type="checkbox" id="catDirIncludeOthers">
                            <span class="toggle-track"><span class="toggle-thumb"></span></span>
                            <span>Avaliar outros produtos e atribuir categoria quando fizer sentido</span>
                        </label>
                        <label class="toggle-sw">
                            <input type="checkbox" id="catDirDryRun">
                            <span class="toggle-track"><span class="toggle-thumb"></span></span>
                            <span>Modo de teste (Dry Run)</span>
                        </label>
                    </div>
                </div>

                <div class="card" style="text-align:center">
                    <button class="btn btn-p" id="catDirBtn" onclick="CatDir.toggle()" style="min-width:180px">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
                        Iniciar Modo Dirigido
                    </button>
                </div>

                <div class="card" id="catDirProgressCard" style="display:none">
                    <div class="card-label">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        Progresso
                    </div>
                    <div class="prog-wrap"><div class="prog-bar" id="catDirProg" style="width:0%"></div></div>
                    <div style="font-size:.8rem;color:var(--muted);margin-top:6px;text-align:center" id="catDirProgLabel">0 / 0</div>
                    <div style="font-size:.78rem;color:var(--text-secondary);margin-top:6px;text-align:center" id="catDirCurrent"></div>
                    <div class="stats-grid" style="margin-top:12px">
                        <div class="stat"><div class="stat-v" id="catDirTotal">0</div><div class="stat-l">Total</div></div>
                        <div class="stat"><div class="stat-v" id="catDirProc">0</div><div class="stat-l">Processados</div></div>
                        <div class="stat"><div class="stat-v green" id="catDirUpd">0</div><div class="stat-l">Atualizados</div></div>
                        <div class="stat"><div class="stat-v" id="catDirSkip">0</div><div class="stat-l">Ignorados</div></div>
                        <div class="stat"><div class="stat-v red" id="catDirErr">0</div><div class="stat-l">Erros</div></div>
                    </div>
                    <div style="font-size:.78rem;color:var(--muted);margin-top:8px;text-align:right" id="catDirCost"></div>
                </div>

                <div class="log-wrap">
                    <div class="log-header">
                        <span class="log-title">Log de execução</span>
                        <button class="log-clear" onclick="$('catDirLog').innerHTML=''">Limpar</button>
                    </div>
                    <div class="log-box" id="catDirLog"><div class="log-l info">Aguardando...</div></div>
                </div>
                <div id="catDirUndo" style="display:none;margin-top:10px;text-align:center">
                    <button class="btn btn-ghost" style="color:var(--orange);border-color:var(--orange)" onclick="CatDir.undo()">
                        &#8635; Desfazer ultima execucao (<span id="catDirUndoCount">0</span> produtos)
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB: Explorer -->
        <div class="tab-panel" id="tab-explorer">
            <div style="display:flex;justify-content:flex-end;margin-bottom:6px">
                <span class="agent-help-btn" onclick="toggleHelp('explorerHelp')" title="Como funciona?">?</span>
            </div>
            <div class="agent-info" id="explorerHelp">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                <div>
                    <strong>Explorador Firestore</strong>
                    Consulta coleções e documentos do Firestore em tempo real, sem precisar acessar o console do Firebase.<br>
                    <strong>Rápido:</strong> informe um caminho direto (ex: <code style="font-size:.8rem;background:#e0e7ff;padding:1px 5px;border-radius:3px">estabelecimentos/ID/Products</code>) e defina o número máximo de documentos retornados.<br>
                    <strong>Avançado:</strong> mesmo que o Rápido, mas com sugestões automáticas de caminho conforme você digita, cache de resultados e log de execução.
                </div>
            </div>
            <div class="card" style="margin-bottom:14px">
                <div class="card-label">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
                    Atalhos de Caminho
                </div>
                <div class="field" style="margin-bottom:10px">
                    <label>Estabelecimento</label>
                    <select id="expEstSel" class="est-sel" onchange="handleEstChange('expEstSel','expEstCustom')">
                        <option value="" disabled>Carregando...</option>
                    </select>
                    <input type="text" id="expEstCustom" class="est-custom" style="display:none" placeholder="ID personalizado" spellcheck="false">
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px">
                    <button class="path-chip" onclick="ExpPaths.use('estabelecimentos/{id}/Products')" title="produtos">
                        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                        Produtos
                    </button>
                    <button class="path-chip" onclick="ExpPaths.use('estabelecimentos/{id}/ProductCategories')" title="categorias">
                        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        Categorias
                    </button>
                    <button class="path-chip" onclick="ExpPaths.use('estabelecimentos/{id}/ProductSubcategories')" title="subcategorias">
                        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                        Subcategorias
                    </button>
                    <button class="path-chip" onclick="ExpPaths.use('estabelecimentos/{id}/ReturnSales')" title="vendas com retorno">
                        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.8"/></svg>
                        ReturnSales
                    </button>
                    <button class="path-chip" onclick="ExpPaths.use('estabelecimentos/{id}/Stats')" title="estatísticas gerais">
                        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                        Stats
                    </button>
                    <button class="path-chip" onclick="ExpPaths.use('estabelecimentos/{id}/DailyStats')" title="estatísticas diárias">
                        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        DailyStats
                    </button>
                    <button class="path-chip" onclick="ExpPaths.use('estabelecimentos/{id}/MonthlyStats')" title="estatísticas mensais">
                        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="8" y2="18"/><line x1="12" y1="14" x2="12" y2="18"/><line x1="16" y1="14" x2="16" y2="18"/></svg>
                        MonthlyStats
                    </button>
                </div>
            </div>

            <div class="subtabs">
                <button class="stab active" onclick="switchSub('simple')">Rápido</button>
                <button class="stab" onclick="switchSub('advanced')">Avançado</button>
            </div>

            <div class="spanel active" id="subtab-simple">
                <div class="card">
                    <div class="card-label">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        Explorador Rápido
                    </div>
                    <div class="row" style="margin-bottom:12px">
                        <div class="field"><label>Caminho</label><input type="text" id="sPath" placeholder="estabelecimentos/ID/Products" spellcheck="false"></div>
                        <div class="field sm"><label>Max</label><input type="number" id="sMax" value="5" min="1" max="50"></div>
                        <button class="btn btn-p" onclick="SExp.explore()" style="margin-bottom:0;align-self:flex-end">Explorar</button>
                    </div>
                    <div class="btn-group"><button class="btn btn-ghost" onclick="SExp.copy()">Copiar JSON</button></div>
                </div>
                <div class="json-out" id="sResult">Os resultados aparecerao aqui...</div>
            </div>

            <div class="spanel" id="subtab-advanced">
                <div class="card">
                    <div class="card-label">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                        Explorador Avançado
                    </div>
                    <div class="row" style="margin-bottom:12px">
                        <div class="field field-rel"><label>Caminho</label><input type="text" id="aPath" placeholder="estabelecimentos/ID/Products" oninput="AExp.onInput()" spellcheck="false"><div class="sugg-drop" id="aSugg"></div></div>
                        <div class="field sm"><label>Max</label><input type="number" id="aMax" value="10" min="1" max="50"></div>
                        <button class="btn btn-p" onclick="AExp.explore()" style="margin-bottom:0;align-self:flex-end">Explorar</button>
                    </div>
                    <div class="btn-group"><button class="btn btn-ghost" onclick="AExp.copy()">Copiar JSON</button><button class="btn btn-ghost" onclick="AExp.cache()">Ver Cache</button></div>
                </div>
                <div class="json-out" id="aResult">Os resultados aparecerao aqui...</div>
                <div class="log-wrap">
                    <div class="log-header">
                        <span class="log-title">Log de execução</span>
                        <button class="log-clear" onclick="$('explorerLog').innerHTML=''">Limpar</button>
                    </div>
                    <div class="log-box" id="explorerLog"><div class="log-l info">Aguardando...</div></div>
                </div>
            </div>
        </div>
        <!-- TAB: Settings -->
        <div class="tab-panel" id="tab-settings">
            <div class="card" style="margin-bottom:16px">
                <div class="card-label">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    Credenciais de Acesso
                </div>
                <p style="font-size:.82rem;color:var(--text-secondary);margin-bottom:14px">
                    Altere o usuario e senha utilizados no login. Voce sera redirecionado para o login apos salvar.
                </p>
                <div style="display:grid;gap:10px;max-width:400px">
                    <div class="field">
                        <label>Novo usuario</label>
                        <input type="text" id="settUser" autocomplete="off" spellcheck="false" placeholder="novo usuario">
                    </div>
                    <div class="field">
                        <label>Nova senha</label>
                        <input type="password" id="settPass" autocomplete="new-password" placeholder="nova senha">
                    </div>
                    <div class="field">
                        <label>Confirmar senha</label>
                        <input type="password" id="settPassConfirm" autocomplete="new-password" placeholder="repita a senha">
                    </div>
                    <button class="btn btn-p" style="width:fit-content" onclick="Settings.saveCredentials()">Salvar credenciais</button>
                </div>
            </div>

            <div class="card" style="margin-bottom:16px">
                <div class="card-label">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                    Chave API OpenAI
                </div>
                <p style="font-size:.82rem;color:var(--text-secondary);margin-bottom:14px">
                    Chave atual: <code id="settKeyPreview" style="font-family:var(--mono);font-size:.8rem;background:var(--surface-alt);padding:2px 6px;border-radius:4px">nao configurada</code>
                </p>
                <div style="display:grid;gap:10px;max-width:400px">
                    <div class="field">
                        <label>Nova chave</label>
                        <div style="position:relative">
                            <input type="password" id="settApiKey" autocomplete="off" spellcheck="false" placeholder="sk-..." style="padding-right:40px;width:100%">
                            <button onclick="Settings.toggleKeyVisibility()" title="Mostrar/ocultar" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:1rem;padding:0;line-height:1" id="settEyeBtn">&#128065;</button>
                        </div>
                    </div>
                    <button class="btn btn-p" style="width:fit-content" onclick="Settings.saveApiKey()">Salvar chave</button>
                </div>
            </div>

            <div class="card" style="margin-bottom:16px">
                <div class="card-label">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    Tema
                </div>
                <div style="display:flex;align-items:center;gap:14px;margin-top:6px">
                    <label class="toggle-label" for="darkToggle" style="display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none">
                        <div style="position:relative;width:44px;height:24px">
                            <input type="checkbox" id="darkToggle" onchange="Settings.toggleTheme()" style="opacity:0;width:0;height:0;position:absolute">
                            <span id="darkTrack" style="position:absolute;inset:0;background:var(--border);border-radius:12px;transition:.2s"></span>
                            <span id="darkThumb" style="position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.2)"></span>
                        </div>
                        <span id="darkLabel" style="font-size:.9rem;color:var(--text)">Tema claro</span>
                    </label>
                </div>
            </div>

            <div class="card" style="margin-bottom:16px">
                <div class="card-label">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Estabelecimentos
                </div>
                <p style="font-size:.82rem;color:var(--text-secondary);margin-bottom:14px">
                    Gerencie a lista de estabelecimentos disponíveis em todos os seletores do painel.
                    Os estabelecimentos padrão não podem ser removidos.
                </p>
                <div id="estListSettings" style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px"></div>
                <div style="display:grid;gap:8px;max-width:400px">
                    <div class="field">
                        <label>ID do estabelecimento (Firestore)</label>
                        <input type="text" id="newEstId" autocomplete="off" spellcheck="false" placeholder="ex: xYz9abc123">
                    </div>
                    <div class="field">
                        <label>Nome exibido na lista</label>
                        <input type="text" id="newEstName" autocomplete="off" spellcheck="false" placeholder="ex: Meu Supermercado">
                    </div>
                    <button class="btn btn-p" style="width:fit-content" onclick="Establishments.add()">Adicionar estabelecimento</button>
                </div>
            </div>

            <div class="card">
                <div class="card-label">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Sessão
                </div>
                <p style="font-size:.82rem;color:var(--text-secondary);margin-bottom:14px">
                    Encerra a sessao atual e redireciona para a tela de login.
                </p>
                <a href="/logout" class="btn btn-d" style="width:fit-content;text-decoration:none">
                    &#x2192; Encerrar sessao
                </a>
            </div>
        </div>
    </div>

    <script>
    const API = window.location.origin;
    let socket, isRunning = false;
    const $ = id => document.getElementById(id);

    // === Toast ===
    const toastIcons = { success:'\u2713', error:'\u2717', warning:'\u26A0', info:'\u2139' };
    function toast(msg, type='info') {
        const c = $('toasts'), t = document.createElement('div');
        t.className = 'toast toast-' + type;
        t.innerHTML = '<span class="ico">'+(toastIcons[type]||'')+' </span><span>' + msg + '</span><button class="close-toast" onclick="this.parentElement.remove()">&times;</button>';
        c.appendChild(t);
        setTimeout(() => { if(t.parentElement) { t.style.animation='toastOut .3s ease forwards'; setTimeout(()=>t.remove(),300); } }, 4000);
    }

    // === Tabs ===
    const TAB_ORDER = ['renamer', 'explorer', 'categorizer', 'settings'];
    function switchTab(n) {
        const idx = TAB_ORDER.indexOf(n);
        document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', i===idx));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        $('tab-'+n).classList.add('active');
    }
    function switchSub(n) {
        document.querySelectorAll('#tab-explorer .stab').forEach((b,i) => b.classList.toggle('active', n==='simple'?i===0:i===1));
        document.querySelectorAll('#tab-explorer .spanel').forEach(p => p.classList.remove('active'));
        $('subtab-'+n).classList.add('active');
    }
    function switchCatSub(n) {
        document.querySelectorAll('#catSubTabs .stab').forEach((b,i) => b.classList.toggle('active', n==='auto'?i===0:i===1));
        document.querySelectorAll('#tab-categorizer > .spanel').forEach(p => p.classList.remove('active'));
        $('catsubtab-'+n).classList.add('active');
    }

    // === Help toggle ===
    function toggleHelp(id) {
        document.getElementById(id).classList.toggle('open');
    }

    // === Establishment helpers ===
    function handleEstChange(selId, inputId) {
        $(inputId).style.display = $(selId).value === '__custom__' ? '' : 'none';
    }
    function getEstId(selId, inputId) {
        const v = $(selId).value;
        return v === '__custom__' ? ($(inputId).value.trim() || '') : v;
    }

    // === Daily stats ===
    function updateDailyStats(d) {
        if(!d) return;
        $('dailyTokens').textContent = (d.tokens||0).toLocaleString();
        $('dailyCost').textContent = '$'+(d.cost||0).toFixed(4);
    }

    // === WebSocket ===
    function initWS() {
        socket = io(API);
        socket.on('connect', () => { $('connBadge').className='conn-status conn-ok'; $('connBadge').textContent='Conectado'; _skelDone(); });
        socket.on('disconnect', () => { $('connBadge').className='conn-status conn-err'; $('connBadge').textContent='Desconectado'; });
        socket.on('renamer_log_update', d => addLog('renamerLog', d.message, d.level));
        socket.on('renamer_progress_update', d => Renamer.progress(d.progress, d.current_product));
        socket.on('renamer_status_update', d => { isRunning=d.running; Renamer.progress(d.progress, d.current_product); Renamer.btnState(); });
        socket.on('renamer_logs_update', d => { if(d.logs?.length){ $('renamerLog').innerHTML=''; d.logs.forEach(l=>addLog('renamerLog',l.message,l.level)); }});
        socket.on('explorer_log_update', d => addLog('explorerLog', d.message, d.level));
        socket.on('explorer_logs_update', d => { if(d.logs?.length){ $('explorerLog').innerHTML=''; d.logs.forEach(l=>addLog('explorerLog',l.message,l.level)); }});
        socket.on('categorizer_log_update', d => addLog('catLog', d.message, d.level));
        socket.on('categorizer_progress_update', d => Cat.progress(d.progress, d.current_product));
        socket.on('categorizer_status_update', d => { Cat.progress(d.progress, d.current_product); Cat.btnState(d.running); });
        socket.on('categorizer_logs_update', d => { if(d.logs?.length){ $('catLog').innerHTML=''; d.logs.forEach(l=>addLog('catLog',l.message,l.level)); }});
        socket.on('categorizer_targeted_log_update', d => addLog('catDirLog', d.message, d.level));
        socket.on('categorizer_targeted_progress_update', d => CatDir.progress(d.progress, d.current_product));
        socket.on('categorizer_targeted_status_update', d => { CatDir.progress(d.progress, d.current_product); CatDir.btnState(d.running); });
        socket.on('categorizer_targeted_logs_update', d => { if(d.logs?.length){ $('catDirLog').innerHTML=''; d.logs.forEach(l=>addLog('catDirLog',l.message,l.level)); }});
        socket.on('daily_stats_update', d => updateDailyStats(d));
        socket.on('openai_quota_exceeded', d => {
            const banner = document.getElementById('quotaBanner');
            if(d?.message) document.getElementById('quotaBannerMsg').innerHTML =
                d.message + ' &mdash; <a href="https://platform.openai.com/account/billing" target="_blank">Verificar saldo</a>';
            banner.classList.add('visible');
        });
    }

    function addLog(id, msg, type) {
        const s=$(id), d=document.createElement('div');
        d.className='log-l '+(type||'info');
        d.textContent=new Date().toLocaleTimeString()+' '+msg;
        s.appendChild(d); s.scrollTop=s.scrollHeight;
    }

    // === Renamer ===
    const Renamer = {
        _loaded: false, _default: null, _saved: null, _selectedCount: 0,

        togglePrompt() {
            $('promptHdr').classList.toggle('open');
            $('promptBd').classList.toggle('open');
        },

        async loadPrompt() {
            try {
                const r = await (await fetch(API+'/api/renamer/prompt')).json();
                if(r.success) { $('promptTa').value=r.prompt; this._default=r.default_prompt; this._saved=r.prompt; this._loaded=true; this.checkPromptDirty(); }
            } catch(e) { $('promptTa').value='Erro: '+e.message; }
        },

        onPromptChange() { this.checkPromptDirty(); },

        checkPromptDirty() {
            const dirty = this._saved && $('promptTa').value.trim() !== this._saved.trim();
            $('promptDot').classList.toggle('show', dirty);
        },

        restorePrompt() {
            if(this._default) { $('promptTa').value=this._default; this.checkPromptDirty(); toast('Prompt padrao restaurado','info'); }
            else this.loadPrompt();
        },

        async savePrompt() {
            const p = $('promptTa').value.trim();
            if(!p) { toast('Prompt vazio','error'); return; }
            try {
                const r = await (await fetch(API+'/api/renamer/prompt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:p})})).json();
                if(r.success) { this._saved=p; this.checkPromptDirty(); toast('Prompt salvo no Firestore','success'); }
                else toast('Erro: '+r.error,'error');
            } catch(e) { toast('Erro: '+e.message,'error'); }
        },

        async loadCategories() {
            const estId = getEstId('renEstSel','renEstCustom');
            if(!estId) { toast('Selecione o estabelecimento','warning'); return; }
            const grid=$('catGrid'), btn=$('btnLoadCats');
            btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Carregando';
            grid.innerHTML='<div class="empty-state"><span class="spinner spinner-dark" style="width:22px;height:22px"></span><span>Buscando categorias...</span></div>';
            try {
                const r = await (await fetch(API+'/api/renamer/categories?estabelecimento_id='+encodeURIComponent(estId))).json();
                if(r.success && r.categories.length) {
                    grid.innerHTML=''; grid.className='cat-grid';
                    r.categories.forEach(cat => {
                        const catId = cat.id || cat;
                        const catName = cat.name || cat;
                        const id='c-'+catId.replace(/\s/g,'-');
                        const item=document.createElement('div'); item.className='cat-item';
                        item.innerHTML='<input type="checkbox" class="ccb" id="'+id+'" value="'+catId+'" onchange="Renamer.updateCount()"><label for="'+id+'">'+catName+'</label>';
                        item.onclick = e => { if(e.target.tagName!=='INPUT') { const cb=item.querySelector('input'); cb.checked=!cb.checked; Renamer.updateCount(); }};
                        grid.appendChild(item);
                    });
                    this.updateCount();
                    toast(r.categories.length+' categorias carregadas','success');
                } else { grid.innerHTML='<div class="empty-state"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg><b>Nenhuma categoria encontrada</b><span>O estabelecimento não possui categorias cadastradas</span></div>'; grid.className=''; }
            } catch(e) { grid.innerHTML='<div class="empty-state"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><b>Erro ao carregar</b><span>'+e.message+'</span></div>'; grid.className=''; toast('Erro ao carregar','error'); }
            btn.disabled=false; btn.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.8"/></svg> Carregar';
        },

        updateCount() {
            const n = document.querySelectorAll('.ccb:checked').length;
            const badge = $('catCount');
            badge.textContent = n;
            badge.style.display = n > 0 ? 'inline' : 'none';
            document.querySelectorAll('.cat-item').forEach(item => {
                item.classList.toggle('checked', item.querySelector('input').checked);
            });
        },

        selectAll(v) { document.querySelectorAll('.ccb').forEach(c=>c.checked=v); this.updateCount(); },

        async toggle() {
            if(isRunning) {
                try { await fetch(API+'/api/renamer/stop',{method:'POST'}); toast('Parada solicitada','warning'); } catch(e) { toast('Erro: '+e.message,'error'); }
                return;
            }
            const estId=getEstId('renEstSel','renEstCustom');
            const delay=parseFloat($('delay').value);
            const dryRun=$('dryRun').checked;
            const cats=[...document.querySelectorAll('.ccb:checked')].map(c=>c.value);
            const prompt=$('promptTa').value.trim();

            if(!estId) { toast('Selecione o estabelecimento','warning'); return; }
            if(!cats.length) { toast('Selecione ao menos uma categoria','warning'); return; }


            const btn=$('btnStart');
            btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Iniciando...';

            const payload = { estabelecimento_id:estId, delay, dry_run:dryRun, categories:cats };
            if(prompt) payload.custom_prompt = prompt;
            try {
                const r = await fetch(API+'/api/renamer/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
                if(r.ok) { isRunning=true; $('progressArea').classList.add('active'); $('renamerLog').innerHTML=''; toast('Automacao iniciada'+(dryRun?' (Dry Run)':''),'success'); }
                else { const e=await r.json(); toast('Erro: '+e.error,'error'); }
            } catch(e) { toast('Erro: '+e.message,'error'); }
            btn.disabled=false; this.btnState();
        },

        progress(p, cur) {
            if(p) {
                $('sTotal').textContent=p.total;
                $('sProc').textContent=p.processed;
                $('sUpd').textContent=p.updated;
                $('sUnch').textContent=p.unchanged;
                $('sErr').textContent=p.errors;
                $('tokensVal').textContent=(p.tokens_used||0).toLocaleString();
                $('costVal').textContent='$'+(p.estimated_cost||0).toFixed(4);
                const pct = p.total>0 ? (p.processed/p.total)*100 : 0;
                $('pbar').style.width=pct+'%';
                $('ptext').textContent=Math.round(pct)+'%';
                if(p.processed>0) $('progressArea').classList.add('active');
                if(p.processed>=p.total && p.total>0) this.refreshUndo();
            }
            if(cur) {
                $('curInfo').innerHTML='<strong>'+cur.index+'/'+cur.total+'</strong> &mdash; <strong>ID:</strong> '+cur.id+'<br><strong>Original:</strong> '+cur.name+'<br><strong>Novo:</strong> '+(cur.improved_name||'processando...');
                $('curItem').classList.add('show');
            }
        },

        btnState() {
            const b=$('btnStart');
            if(isRunning) {
                b.className='btn btn-d btn-w';
                b.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg> Parar';
            } else {
                b.className='btn btn-p btn-w';
                b.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg> Iniciar';
            }
        },

        async refreshUndo() {
            try {
                const r = await (await fetch(API+'/api/renamer/undo-info')).json();
                const d = $('renUndo');
                if(r.available){ $('renUndoCount').textContent=r.count; d.style.display=''; }
                else d.style.display='none';
            } catch(e){}
        },

        async undo() {
            if(!confirm('Desfazer todas as '+$('renUndoCount').textContent+' alteracoes de nomes da ultima execucao?')) return;
            try {
                const r = await (await fetch(API+'/api/renamer/undo',{method:'POST'})).json();
                if(r.success){ toast('Revertidos '+r.reverted+' produtos'+(r.errors?' ('+r.errors+' erros)':''),'success'); $('renUndo').style.display='none'; }
                else toast('Erro: '+r.error,'error');
            } catch(e){ toast('Erro: '+e.message,'error'); }
        }
    };

    // === JSON syntax highlight ===
    function syntaxHighlight(obj) {
        const json = JSON.stringify(obj, null, 2);
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?|[{}\[\],:])/g, match => {
            if (/^".*":$/.test(match))  return '<span class="json-key">'  + match + '</span>';
            if (/^"/.test(match))        return '<span class="json-str">'  + match + '</span>';
            if (/true|false/.test(match)) return '<span class="json-bool">' + match + '</span>';
            if (/null/.test(match))      return '<span class="json-null">' + match + '</span>';
            if (/^[{}\[\],:]$/.test(match)) return '<span class="json-punc">' + match + '</span>';
            return '<span class="json-num">' + match + '</span>';
        });
    }
    function renderJson(el, obj) {
        try { el.innerHTML = syntaxHighlight(obj); }
        catch(e) { el.textContent = JSON.stringify(obj, null, 2); }
    }

    // === Explorer Path Shortcuts ===
    const ExpPaths = {
        use(template) {
            const estId = getEstId('expEstSel', 'expEstCustom');
            if (template.includes('{id}') && !estId) {
                toast('Selecione o estabelecimento nos atalhos', 'warning'); return;
            }
            const path = template.replace('{id}', estId);
            // Preenche o campo do painel ativo
            const active = document.querySelector('#tab-explorer .spanel.active');
            const input = active && active.querySelector('input[type="text"]');
            if (input) { input.value = path; input.dispatchEvent(new Event('input')); }
        }
    };

    // === Simple Explorer ===
    const SExp = {
        _json: null,
        async explore() {
            const path=$('sPath').value.trim(), max=parseInt($('sMax').value)||5;
            if(!path){toast('Informe o caminho','warning');return;}
            $('sResult').textContent='Carregando...';
            try { const r=await(await fetch(API+'/api/explorer-simple/explore',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path,max_docs:max})})).json(); this._json=r; renderJson($('sResult'),r); }
            catch(e){$('sResult').textContent='Erro: '+e.message;}
        },
        copy() { if(this._json) navigator.clipboard.writeText(JSON.stringify(this._json,null,2)).then(()=>toast('JSON copiado','success')).catch(()=>toast('Erro ao copiar','error')); }
    };

    // === Advanced Explorer ===
    const AExp = {
        _json: null, _to: null,
        async explore() {
            const path=$('aPath').value.trim(), max=parseInt($('aMax').value)||10;
            $('aResult').textContent='Carregando...';
            try { const r=await(await fetch(API+'/api/explorer/explore',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path,max_docs:max})})).json(); this._json=r; renderJson($('aResult'),r); }
            catch(e){$('aResult').textContent='Erro: '+e.message;}
        },
        onInput() { clearTimeout(this._to); this._to=setTimeout(()=>this.suggest(),400); },
        async suggest() {
            const path=$('aPath').value.trim(), list=$('aSugg');
            if(!path){list.style.display='none';return;}
            try { const r=await(await fetch(API+'/api/explorer/suggestions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path})})).json();
            if(r.success&&r.suggestions.length){list.innerHTML='';r.suggestions.forEach(s=>{const o=document.createElement('div');o.className='sugg-opt';o.textContent=s;o.onclick=()=>{$('aPath').value=s;list.style.display='none';};list.appendChild(o);});list.style.display='block';}else list.style.display='none';}catch(e){list.style.display='none';}
        },
        async cache() { try{const r=await(await fetch(API+'/api/explorer/cache')).json();this._json=r;renderJson($('aResult'),r);}catch(e){$('aResult').textContent='Erro: '+e.message;} },
        copy() { if(this._json) navigator.clipboard.writeText(JSON.stringify(this._json,null,2)).then(()=>toast('JSON copiado','success')).catch(()=>toast('Erro ao copiar','error')); }
    };

    // === Categorizador ===
    const Cat = {
        _running: false,
        _default: '',
        _saved: '',
        _loaded: false,

        async toggle() {
            if(this._running) { await this.stop(); }
            else { await this.start(); }
        },

        async start() {
            const estId = getEstId('catEstSel','catEstCustom');
            if(!estId){ toast('Selecione o estabelecimento','warning'); return; }
            const delay = parseFloat($('catDelay').value)||0.5;
            const dryRun = $('catDryRun').checked;
            const onlyUncategorized = $('catOnlyUncategorized').checked;
            const filterCategory = $('catFilterCategory').value.trim();
            const prompt = $('catPromptTa').value.trim();
            const payload = {estabelecimento_id:estId, delay, dry_run:dryRun, only_uncategorized:onlyUncategorized};
            if(filterCategory) payload.filter_category_id = filterCategory;
            if(prompt) payload.custom_prompt = prompt;
            try {
                const r = await (await fetch(API+'/api/categorizer/start',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(payload)
                })).json();
                if(r.success){ this._running=true; this.btnState(true); $('catProgressCard').style.display=''; $('catLog').innerHTML=''; toast('Categorizacao iniciada','success'); }
                else { toast(r.error||'Erro ao iniciar','error'); }
            } catch(e){ toast('Erro: '+e.message,'error'); }
        },

        async stop() {
            try {
                await fetch(API+'/api/categorizer/stop',{method:'POST'});
                this._running=false; this.btnState(false); toast('Interrompendo...','warning');
            } catch(e){ toast('Erro: '+e.message,'error'); }
        },

        async loadPrompt() {
            try {
                const r = await (await fetch(API+'/api/categorizer/prompt')).json();
                if(r.success){ $('catPromptTa').value=r.prompt; this._default=r.default_prompt; this._saved=r.prompt; this._loaded=true; this.checkPromptDirty(); }
            } catch(e){ $('catPromptTa').value='Erro: '+e.message; }
        },

        async savePrompt() {
            const p = $('catPromptTa').value.trim();
            if(!p){ toast('Prompt vazio','error'); return; }
            try {
                const r = await (await fetch(API+'/api/categorizer/prompt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:p})})).json();
                if(r.success){ this._saved=p; this.checkPromptDirty(); toast('Prompt salvo no Firestore','success'); }
                else toast('Erro: '+r.error,'error');
            } catch(e){ toast('Erro: '+e.message,'error'); }
        },

        restorePrompt() {
            if(this._default){ $('catPromptTa').value=this._default; this.checkPromptDirty(); }
        },

        onPromptChange() { this.checkPromptDirty(); },

        checkPromptDirty() {
            const dot = $('catPromptDot');
            if(!dot) return;
            dot.style.display = (this._loaded && $('catPromptTa').value.trim() !== this._saved) ? 'inline-block' : 'none';
        },

        togglePrompt() {
            const bd=$('catPromptBd'), hdr=$('catPromptHdr');
            const open = bd.style.display!=='none' && bd.style.display!=='';
            bd.style.display = open ? 'none' : 'block';
            hdr.querySelector('.arr').style.transform = open ? '' : 'rotate(180deg)';
        },

        progress(prog, cur) {
            if(!prog) return;
            const pct = prog.total>0 ? Math.round(prog.processed/prog.total*100) : 0;
            $('catProg').style.width = pct+'%';
            $('catProgLabel').textContent = `${prog.processed} / ${prog.total} (${pct}%)`;
            $('catTotal').textContent = prog.total||0;
            $('catProc').textContent = prog.processed||0;
            $('catUpd').textContent = prog.updated||0;
            $('catErr').textContent = prog.errors||0;
            if(prog.estimated_cost!=null) $('catCost').textContent = `Tokens: ${(prog.tokens_used||0).toLocaleString()} | Custo: $${(prog.estimated_cost||0).toFixed(4)}`;
            if(cur && cur.name){ $('catCurrent').textContent = `[${cur.index}/${cur.total}] ${cur.name}`; }
            if(prog.total>0) $('catProgressCard').style.display='';
            if(prog.processed>=prog.total && prog.total>0){ this._running=false; this.btnState(false); this.refreshUndo(); }
        },

        btnState(running) {
            this._running = running!=null ? running : this._running;
            const b=$('catBtn');
            if(this._running){ b.className='btn btn-d'; b.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg> Parar'; }
            else { b.className='btn btn-p'; b.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg> Iniciar Categorização'; }
        },

        async refreshUndo() {
            try {
                const r = await (await fetch(API+'/api/categorizer/undo-info')).json();
                const d = $('catUndo');
                if(r.available){ $('catUndoCount').textContent=r.count; d.style.display=''; }
                else d.style.display='none';
            } catch(e){}
        },

        async undo() {
            if(!confirm('Desfazer todas as '+$('catUndoCount').textContent+' alteracoes de categoria da ultima execucao?')) return;
            try {
                const r = await (await fetch(API+'/api/categorizer/undo',{method:'POST'})).json();
                if(r.success){ toast('Revertidos '+r.reverted+' produtos'+(r.errors?' ('+r.errors+' erros)':''),'success'); $('catUndo').style.display='none'; }
                else toast('Erro: '+r.error,'error');
            } catch(e){ toast('Erro: '+e.message,'error'); }
        },

        async loadCategories() {
            const estId = getEstId('catEstSel','catEstCustom');
            if(!estId){ toast('Selecione o estabelecimento','warning'); return; }
            const btn = $('catLoadCatsBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Carregando';
            const sel = $('catFilterCategory');
            sel.innerHTML = '<option value="">-- Todas as categorias --</option>';
            try {
                const r = await (await fetch(API+'/api/categorizer/categories?estabelecimento_id='+encodeURIComponent(estId))).json();
                if(r.categories) {
                    r.categories.forEach(cat => {
                        const o = document.createElement('option');
                        o.value = cat.id || cat;
                        o.textContent = cat.name || cat;
                        sel.appendChild(o);
                    });
                    toast(r.categories.length+' categorias carregadas','success');
                }
            } catch(e) { toast('Erro ao carregar categorias','error'); }
            btn.disabled = false;
            btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.8"/></svg> Carregar Categorias';
        },

        onOnlyUncategorizedChange(checked) {
            const btn = $('catLoadCatsBtn');
            const sel = $('catFilterCategory');
            btn.disabled = checked;
            sel.disabled = checked;
            sel.style.opacity = checked ? '.4' : '';
            sel.style.cursor = checked ? 'not-allowed' : '';
        }
    };

    // === Categorizador Dirigido ===
    const CatDir = {
        _running: false,

        async loadCategories() {
            const estId = getEstId('catDirEstSel','catDirEstCustom');
            if(!estId){ toast('Selecione o estabelecimento','warning'); return; }
            try {
                const r = await (await fetch(API+'/api/categorizer/categories?estabelecimento_id='+encodeURIComponent(estId))).json();
                if(!r.success){ toast(r.error||'Erro','error'); return; }
                const cats = r.categories;
                const sel = $('catDirTarget');
                sel.innerHTML = '<option value="">-- Selecione a categoria alvo --</option>';
                cats.forEach(c => { const o=document.createElement('option'); o.value=c.id; o.textContent=c.name+' ('+c.id+')'; sel.appendChild(o); });
                toast(cats.length+' categorias carregadas','success');
            } catch(e){ toast('Erro: '+e.message,'error'); }
        },

        async toggle() { this._running ? await this.stop() : await this.start(); },

        async start() {
            const estId = getEstId('catDirEstSel','catDirEstCustom');
            const targetCatId = $('catDirTarget').value;
            if(!estId){ toast('Selecione o estabelecimento','warning'); return; }
            if(!targetCatId){ toast('Selecione a categoria alvo','warning'); return; }
            const includeOthers = $('catDirIncludeOthers').checked;
            const delay = parseFloat($('catDirDelay').value)||0.5;
            const dryRun = $('catDirDryRun').checked;
            try {
                const r = await (await fetch(API+'/api/categorizer-targeted/start',{
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({estabelecimento_id:estId, target_category_id:targetCatId, include_others:includeOthers, delay, dry_run:dryRun})
                })).json();
                if(r.success){ this._running=true; this.btnState(true); $('catDirProgressCard').style.display=''; $('catDirLog').innerHTML=''; toast('Modo dirigido iniciado','success'); }
                else toast(r.error||'Erro ao iniciar','error');
            } catch(e){ toast('Erro: '+e.message,'error'); }
        },

        async stop() {
            try { await fetch(API+'/api/categorizer-targeted/stop',{method:'POST'}); this._running=false; this.btnState(false); toast('Interrompendo...','warning'); }
            catch(e){ toast('Erro: '+e.message,'error'); }
        },

        progress(prog, cur) {
            if(!prog) return;
            const pct = prog.total>0 ? Math.round(prog.processed/prog.total*100) : 0;
            $('catDirProg').style.width=pct+'%';
            $('catDirProgLabel').textContent=prog.processed+' / '+prog.total+' ('+pct+'%)';
            $('catDirTotal').textContent=prog.total||0;
            $('catDirProc').textContent=prog.processed||0;
            $('catDirUpd').textContent=prog.updated||0;
            $('catDirSkip').textContent=prog.skipped||0;
            $('catDirErr').textContent=prog.errors||0;
            if(prog.estimated_cost!=null) $('catDirCost').textContent='Tokens: '+(prog.tokens_used||0).toLocaleString()+' | Custo: $'+(prog.estimated_cost||0).toFixed(4);
            if(cur&&cur.name) $('catDirCurrent').textContent='['+cur.index+'/'+cur.total+'] '+cur.name;
            if(prog.total>0) $('catDirProgressCard').style.display='';
            if(prog.processed>=prog.total&&prog.total>0){ this._running=false; this.btnState(false); this.refreshUndo(); }
        },

        btnState(running) {
            this._running = running!=null ? running : this._running;
            const b=$('catDirBtn');
            if(this._running){ b.className='btn btn-d'; b.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg> Parar'; }
            else { b.className='btn btn-p'; b.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg> Iniciar Modo Dirigido'; }
        },

        async refreshUndo() {
            try {
                const r = await (await fetch(API+'/api/categorizer-targeted/undo-info')).json();
                const d = $('catDirUndo');
                if(r.available){ $('catDirUndoCount').textContent=r.count; d.style.display=''; }
                else d.style.display='none';
            } catch(e){}
        },

        async undo() {
            if(!confirm('Desfazer todas as '+$('catDirUndoCount').textContent+' alteracoes de categoria da ultima execucao dirigida?')) return;
            try {
                const r = await (await fetch(API+'/api/categorizer-targeted/undo',{method:'POST'})).json();
                if(r.success){ toast('Revertidos '+r.reverted+' produtos'+(r.errors?' ('+r.errors+' erros)':''),'success'); $('catDirUndo').style.display='none'; }
                else toast('Erro: '+r.error,'error');
            } catch(e){ toast('Erro: '+e.message,'error'); }
        }
    };

    // Close suggestions on click outside
    document.addEventListener('click', e => { if(!e.target.closest('.field-rel')) $('aSugg').style.display='none'; });

    // === Tour ===
    const TOUR_KEY = 'pmm_tour_v1';

    const tourSteps = [
        {
            target: null,
            title: 'Bem-vindo ao Automações Mobile Mercado!',
            text: 'Painel com 3 agentes de IA para gerenciar o catálogo de produtos no Mobile Mercado. Selecione o estabelecimento, configure as opções e deixe a IA trabalhar.',
            tab: null, subtab: null
        },
        {
            target: '.tabs',
            title: 'Navegação',
            text: 'Use as abas para alternar entre o Padronizador de Nomes, o Explorador Firestore, o Categorizador de Produtos e as Configurações do painel.',
            tab: 'renamer', subtab: null
        },
        {
            target: '#tab-renamer',
            title: 'Padronizador de Nomes',
            text: 'Reescreve e padroniza os nomes dos produtos usando IA. Selecione o estabelecimento, clique em Carregar para buscar as categorias, marque as que deseja processar e clique em Iniciar. Ative Modo de teste (Dry Run) para visualizar as alterações sem salvar no Firestore.',
            tab: 'renamer', subtab: null
        },
        {
            target: '#catsubtab-auto',
            title: 'Categorizador Automático',
            text: 'Define categoria e subcategoria para cada produto automaticamente. Use "Apenas produtos sem categoria" para processar só os não categorizados, ou "Carregar Categorias" para filtrar por uma categoria específica. Ative Modo de teste (Dry Run) para simular sem salvar.',
            tab: 'categorizer', subtab: 'auto'
        },
        {
            target: '#catsubtab-dirigido',
            title: 'Categorizador Dirigido',
            text: 'Você escolhe a categoria alvo e a IA define a subcategoria correta. Ideal para categorizar uma categoria específica com mais controle. Ative "Avaliar outros produtos" para que a IA mova produtos de outras categorias quando fizer sentido.',
            tab: 'categorizer', subtab: 'dirigido'
        },
        {
            target: '#tab-explorer',
            title: 'Explorador Firestore',
            text: 'Consulte coleções e documentos do Firestore sem precisar acessar o console do Firebase. O modo Rápido busca por caminho direto; o Avançado oferece sugestões automáticas e cache de resultados.',
            tab: 'explorer', subtab: null
        },
        {
            target: '.app-header',
            title: 'Cabeçalho e Relatório',
            text: 'O badge mostra o status da conexão em tempo real. O contador exibe tokens e custo de todas as chamadas de IA do dia. Clique em Relatório para acessar o histórico completo de execuções.',
            tab: null, subtab: null
        },
        {
            target: null,
            title: 'Tudo pronto!',
            text: 'Você já conhece o painel. Clique no botão ? em qualquer agente para rever as instruções de uso. Nas Configurações você gerencia estabelecimentos, credenciais, chave de API e tema.',
            tab: null, subtab: null, isLast: true
        }
    ];

    const Tour = {
        _step: 0,

        start() {
            this._step = 0;
            document.getElementById('tourOverlay').classList.add('active');
            this._buildDots();
            this._show();
        },

        _buildDots() {
            const dots = document.getElementById('tourDots');
            dots.innerHTML = '';
            tourSteps.forEach((_, i) => {
                const d = document.createElement('div');
                d.className = 'tour-dot';
                d.id = 'tourDot' + i;
                dots.appendChild(d);
            });
        },

        _show() {
            const step = tourSteps[this._step];
            if (step.tab) switchTab(step.tab);
            if (step.subtab) {
                setTimeout(() => {
                    if (step.tab === 'categorizer') switchCatSub(step.subtab);
                    setTimeout(() => this._render(step), 80);
                }, 80);
            } else {
                setTimeout(() => this._render(step), step.tab ? 80 : 0);
            }
        },

        _render(step) {
            const total = tourSteps.length;
            document.getElementById('tourStepLabel').textContent = `Passo ${this._step + 1} de ${total}`;
            document.getElementById('tourTitle').textContent = step.title;
            document.getElementById('tourText').textContent = step.text;
            document.querySelectorAll('.tour-dot').forEach((d, i) => d.classList.toggle('active', i === this._step));

            const prev = document.getElementById('tourPrev');
            const next = document.getElementById('tourNext');
            prev.style.visibility = this._step === 0 ? 'hidden' : '';
            next.textContent = step.isLast ? 'Concluir' : 'Próximo';

            const spotlight = document.getElementById('tourSpotlight');
            const card = document.getElementById('tourCard');
            card.style.display = '';

            if (!step.target) {
                spotlight.style.display = 'none';
                card.style.top = '50%';
                card.style.left = '50%';
                card.style.transform = 'translate(-50%, -50%)';
                return;
            }

            const el = document.querySelector(step.target);
            if (!el) {
                spotlight.style.display = 'none';
                card.style.top = '50%';
                card.style.left = '50%';
                card.style.transform = 'translate(-50%, -50%)';
                return;
            }

            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            setTimeout(() => {
                const rect = el.getBoundingClientRect();
                const pad = 7;
                spotlight.style.display = '';
                spotlight.style.top  = (rect.top  - pad) + 'px';
                spotlight.style.left = (rect.left - pad) + 'px';
                spotlight.style.width  = (rect.width  + pad * 2) + 'px';
                spotlight.style.height = (rect.height + pad * 2) + 'px';

                card.style.transform = '';
                const cardW = 330;
                const cardH = card.offsetHeight || 210;
                const vw = window.innerWidth, vh = window.innerHeight;

                let top = (rect.bottom + pad + 14 + cardH < vh - 16)
                    ? rect.bottom + pad + 14
                    : rect.top - pad - 14 - cardH;
                top = Math.max(12, Math.min(top, vh - cardH - 12));

                let left = rect.left + rect.width / 2 - cardW / 2;
                left = Math.max(12, Math.min(left, vw - cardW - 12));

                card.style.top  = top  + 'px';
                card.style.left = left + 'px';
            }, 60);
        },

        next() {
            if (this._step >= tourSteps.length - 1) { this.finish(); return; }
            this._step++;
            this._show();
        },

        prev() {
            if (this._step <= 0) return;
            this._step--;
            this._show();
        },

        skip()   { this.finish(); },
        finish() {
            document.getElementById('tourOverlay').classList.remove('active');
            document.getElementById('tourCard').style.display = 'none';
            document.getElementById('tourSpotlight').style.display = 'none';
            localStorage.setItem(TOUR_KEY, '1');
        }
    };

    // === Skeleton ===
    let _skelPending = 2; // aguarda: Settings.load (tema Firestore) + socket connect
    let _skelHidden = false;
    function _skelDone() {
        if (--_skelPending <= 0) _hideSkel();
    }
    function _hideSkel() {
        if (_skelHidden) return;
        _skelHidden = true;
        _skelPending = 0;
        const s = document.getElementById('appSkeleton');
        if (!s) return;
        s.classList.add('sk-hide');
        setTimeout(() => { if (s.parentNode) s.remove(); }, 380);
        // Inicia tour após o conteúdo ser visível
        if (!localStorage.getItem(TOUR_KEY)) Tour.start();
    }

    // === Establishments ===
    const Establishments = {
        _list: [],

        async load() {
            try {
                const r = await fetch(API + '/api/settings/estabelecimentos');
                const d = await r.json();
                if (d.success) {
                    this._list = d.estabelecimentos;
                    this._populate();
                    this._renderList();
                }
            } catch(e) {
                // Fallback: popula com os padrões para não deixar os selects vazios
                this._list = [
                    {id: 'estabelecimento-teste', name: 'Estabelecimento Teste', default: true},
                    {id: 'jQQjHTCc2zW1tuZMQzGF', name: 'Zero Grau', default: true},
                ];
                this._populate();
            } finally {
                // establishments não bloqueia o skeleton
            }
        },

        async _reload() {
            try {
                const r = await fetch(API + '/api/settings/estabelecimentos');
                const d = await r.json();
                if (d.success) {
                    this._list = d.estabelecimentos;
                    this._populate();
                    this._renderList();
                }
            } catch(e) {}
        },

        _populate() {
            const SEL_IDS = ['renEstSel', 'catEstSel', 'catDirEstSel', 'expEstSel'];
            SEL_IDS.forEach(selId => {
                const sel = document.getElementById(selId);
                if (!sel) return;
                const prev = sel.value;
                sel.innerHTML = '';
                this._list.forEach(e => {
                    const opt = document.createElement('option');
                    opt.value = e.id;
                    opt.textContent = e.name;
                    sel.appendChild(opt);
                });
                const customOpt = document.createElement('option');
                customOpt.value = '__custom__';
                customOpt.textContent = 'Personalizado...';
                sel.appendChild(customOpt);
                // Restaura seleção anterior se ainda existir
                if (prev && [...sel.options].some(o => o.value === prev)) {
                    sel.value = prev;
                }
            });
        },

        _renderList() {
            const el = document.getElementById('estListSettings');
            if (!el) return;
            if (!this._list.length) {
                el.innerHTML = '<div style="color:var(--muted);font-size:.82rem">Nenhum estabelecimento cadastrado.</div>';
                return;
            }
            el.innerHTML = this._list.map(e => {
                const nameH = e.name.replace(/&/g,'&amp;').replace(/</g,'&lt;');
                const idH   = e.id.replace(/&/g,'&amp;').replace(/</g,'&lt;');
                return `<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding:9px 12px;background:var(--surface-alt);border:1px solid var(--border);border-radius:var(--radius)">
                    <div style="overflow:hidden">
                        <span style="font-size:.84rem;font-weight:600;color:var(--text)">${nameH}</span>
                        <span style="font-size:.73rem;color:var(--muted);margin-left:8px;font-family:var(--mono);word-break:break-all">${idH}</span>
                        ${e.default ? '<span style="font-size:.68rem;background:var(--accent-light);color:var(--accent);padding:1px 7px;border-radius:9px;margin-left:6px;font-weight:600;white-space:nowrap">Padrão</span>' : ''}
                    </div>
                    ${!e.default ? `<button onclick="Establishments.remove('${idH}')" title="Remover" style="flex-shrink:0;background:none;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;color:var(--red);font-size:.8rem;padding:3px 8px;white-space:nowrap;transition:background .15s" onmouseover="this.style.background='var(--red-light)'" onmouseout="this.style.background='none'">Remover</button>` : ''}
                </div>`;
            }).join('');
        },

        async add() {
            const id   = ($('newEstId').value || '').trim();
            const name = ($('newEstName').value || '').trim();
            if (!id || !name) { toast('Preencha o ID e o nome', 'warning'); return; }
            try {
                const r = await fetch(API + '/api/settings/estabelecimentos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id, name})
                });
                const d = await r.json();
                if (d.success) {
                    $('newEstId').value = '';
                    $('newEstName').value = '';
                    toast('Estabelecimento adicionado', 'success');
                    await this._reload();
                } else {
                    toast(d.error || 'Erro ao adicionar', 'error');
                }
            } catch(e) { toast('Erro de conexao', 'error'); }
        },

        async remove(id) {
            if (!confirm('Remover "' + id + '" da lista?')) return;
            try {
                const r = await fetch(API + '/api/settings/estabelecimentos/' + encodeURIComponent(id), {method: 'DELETE'});
                const d = await r.json();
                if (d.success) {
                    toast('Estabelecimento removido', 'success');
                    await this._reload();
                } else {
                    toast(d.error || 'Erro ao remover', 'error');
                }
            } catch(e) { toast('Erro de conexao', 'error'); }
        },
    };

    // === Settings ===
    const Settings = {
        initTheme() {
            // Aplica imediatamente via localStorage para evitar flash, load() sincroniza depois
            const dark = localStorage.getItem('theme') === 'dark';
            document.body.classList.toggle('dark', dark);
            this._updateThemeUI(dark);
            const cb = $('darkToggle');
            if (cb) cb.checked = dark;
        },
        _updateThemeUI(dark) {
            const track = $('darkTrack');
            const thumb = $('darkThumb');
            const label = $('darkLabel');
            if (track) track.style.background = dark ? 'var(--accent)' : 'var(--border)';
            if (thumb) thumb.style.left = dark ? '23px' : '3px';
            if (label) label.textContent = dark ? 'Tema escuro' : 'Tema claro';
        },
        toggleTheme() {
            const dark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', dark ? 'dark' : 'light');
            this._updateThemeUI(dark);
            fetch(API+'/api/settings/theme', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({tema: dark})
            }).catch(()=>{});
        },
        async load() {
            try {
                const r = await fetch(API+'/api/settings');
                const d = await r.json();
                // Credenciais
                const u = $('settUser');
                if (u) u.placeholder = d.username || '';
                const prev = $('settKeyPreview');
                if (prev) prev.textContent = d.api_key_set ? d.api_key_preview : 'nao configurada';
                // Tema — sincroniza com Firestore e atualiza localStorage
                const serverDark = d.tema === true;
                const localDark = localStorage.getItem('theme') === 'dark';
                if (serverDark !== localDark) {
                    document.body.classList.toggle('dark', serverDark);
                    this._updateThemeUI(serverDark);
                    const cb = $('darkToggle');
                    if (cb) cb.checked = serverDark;
                    localStorage.setItem('theme', serverDark ? 'dark' : 'light');
                }
            } catch(e) {
            } finally {
                _skelDone();
            }
        },
        toggleKeyVisibility() {
            const inp = $('settApiKey');
            const btn = $('settEyeBtn');
            if (!inp) return;
            const show = inp.type === 'password';
            inp.type = show ? 'text' : 'password';
            if (btn) btn.innerHTML = show ? '&#128065;&#65038;' : '&#128065;';
        },
        async saveCredentials() {
            const user = ($('settUser').value || '').trim();
            const pass = ($('settPass').value || '').trim();
            const confirm = ($('settPassConfirm').value || '').trim();
            if (!user || !pass) { toast('Preencha usuario e senha', 'warning'); return; }
            if (pass !== confirm) { toast('As senhas nao coincidem', 'error'); return; }
            try {
                const r = await fetch(API+'/api/settings/credentials', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({username:user, password:pass})
                });
                const d = await r.json();
                if (d.success) {
                    toast('Credenciais salvas. Faca login novamente.', 'success');
                    $('settPass').value = '';
                    $('settPassConfirm').value = '';
                    setTimeout(() => window.location.href = '/logout', 1800);
                } else {
                    toast(d.error || 'Erro ao salvar', 'error');
                }
            } catch(e) { toast('Erro de conexao', 'error'); }
        },
        async saveApiKey() {
            const key = ($('settApiKey').value || '').trim();
            if (!key) { toast('Informe a chave', 'warning'); return; }
            try {
                const r = await fetch(API+'/api/settings/openai-key', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({api_key:key})
                });
                const d = await r.json();
                if (d.success) {
                    toast('Chave OpenAI atualizada', 'success');
                    $('settApiKey').value = '';
                    this.load();
                } else {
                    toast(d.error || 'Erro ao salvar chave', 'error');
                }
            } catch(e) { toast('Erro de conexao', 'error'); }
        },
    };

    document.addEventListener('DOMContentLoaded', () => {
        Settings.initTheme();  // aplica tema via localStorage (sem piscar)
        initWS();
        fetch(API+'/api/stats/daily').then(r=>r.json()).then(d=>{ if(d.today) updateDailyStats(d.today); }).catch(()=>{});
        Renamer.loadPrompt();
        Cat.loadPrompt();
        // Skeleton some quando: Settings.load() (tema Firestore) + socket connect
        Settings.load();        // _skelDone() chamado no finally
        Establishments.load();  // carrega em paralelo, não bloqueia skeleton
        // Segurança: se conexão ou Firestore demorar demais, remove skeleton após 5s
        setTimeout(() => _hideSkel(), 5000);
    });
    </script>
</body>
</html>
